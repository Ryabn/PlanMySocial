
/**
 * @author Ryan Yang
 * testlink: file:///Users/ryanyang/Desktop/Workspace/ScheduleMe/docs/assets/testComm/client.html?id=1t78pQ0KDxGeuI1OKHbR
 * 
 * @todo implement previous submission
 */

let ROOM_ID;
let HOST_ID;
let MCAST_ID;
let ROOM_CONNECTION_CODE;

function load(){
    parseURL();
    if(hasData()){
        let d = "";
        connected(d);
    }else{
        connectWithHost();
    }
}
/**
 * @description - Prevent connecting with host as a new client in case of refresh
 */
function hasData(){
    return false;
}

/**
 * @description - Parses url and returns room id for clients
 */
function parseURL() {
    ROOM_ID = (new URLSearchParams(window.location.search)).get('id');
    display(`The current http relay code is: ${ROOM_ID}`);
}

/**
 * @description - Using room ID, it connects with host through httprelay and gets a new room code generated by the host.
 * After a successful GET request to the httprelay node, function calls @callback - connected
 */
function connectWithHost(){
    const ROOM_URL = httpRelayLink + ROOM_ID;
    getReq(ROOM_URL, connected);
}

/**
 * @description - Upon successful connection with host, defines all local variables with plan meta data
 * @param {} d - meta data for local variables @see createRoom() in host.js file
 */
function connected(d){
    HOST_ID = d['code'];
    MCAST_ID = d['mcast'];
    startD = d['data']['startDate'];
    endD = d['data']['endDate'];
    startT = d['data']['startTime'];
    endT = d['data']['endTime'];
    numD = d['data']['numDate'];
    numT = d['data']['numTime'];
    populatePlan();
}
function sendDataToHost(data){
    const HOST_URL = httpRelayLink + HOST_ID;
    postReq(HOST_ID, data, waitForOthers);
}
function waitForOthers(){
    const HOST_URL = httpRelayLink + HOST_ID;
    getReq(HOST_ID, getFinal);
}
function getFinal(){
    const MCAST_URL = httpRelayMCast + MCAST_ID;
    getReq(MCAST_URL, getPlans);
}
function submitVote(vote){
    const HOST_URL = httpRelayLink + HOST_ID;
    postReq(HOST_URL, vote, getResults);
}
function getResults(data){
    //display
}